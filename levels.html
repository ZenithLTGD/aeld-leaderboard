<!DOCTYPE html>
<html>
<head>
<title>Ranked Levels</title>
<link rel="stylesheet" href="style.css">
<style>
  .level-item {
    display: flex;
    align-items: center;
    gap: 16px;
    background: #0d2432;
    border-radius: 14px;
    padding: 16px;
    margin-bottom: 12px;
    border: 1px solid #123040;
    transition: 0.2s;
  }
  .level-item:hover {
    transform: translateY(-2px);
    border-color: #1ccad8;
  }
  .thumbnail {
    width: 160px;
    height: 90px;
    object-fit: cover;
    border-radius: 8px;
    background: #000;
    flex-shrink: 0;
  }
  .level-info {
    flex: 1;
  }
</style>
</head>
<body>

<div class="nav">
  <div class="logo">AELD</div>
  <a href="index.html">Dashboard</a>
  <a href="levels.html">Levels</a>
  <a href="players.html">Top Players</a>
  <a href="submit.html">Submit Record</a>
</div>

<div class="container">
  <h2>Ranked Levels</h2>
  <div id="levelsBox"></div>
</div>

<script>
  // Load Firebase compat libraries
  const loadFirebase = function() {
    const appScript = document.createElement('script');
    appScript.src = "https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js";
    appScript.onload = function() {
      const firestoreScript = document.createElement('script');
      firestoreScript.src = "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js";
      firestoreScript.onload = function() {
        const firebaseConfig = {
          apiKey: "AIzaSyBYwgt-Aq-ZJrgSuOphrJryMxtro",
          authDomain: "aeld-b5856.firebaseapp.com",
          projectId: "aeld-b5856",
          storageBucket: "aeld-b5856.appspot.com",
          messagingSenderId: "372163813001",
          appId: "1:372163813001:web:9ed8679669963063c8f058",
          measurementId: "G-3DMJ6NMZNZ"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Render approved levels with thumbnails
        async function renderLevels() {
          const box = document.getElementById("levelsBox");
          box.innerHTML = '<p style="text-align:center; color:#7fb3c8; padding:40px;">Loading ranked levels...</p>';

          try {
            const snapshot = await db.collection("submissions")
              .where("status", "==", "approved")
              .get();

            box.innerHTML = "";

            if (snapshot.empty) {
              box.innerHTML = `
                <div class="card" style="text-align:center; padding:40px;">
                  No approved levels yet. Approve some in admin! üèÜ
                </div>
              `;
              return;
            }

            const levels = [];
            snapshot.forEach((doc) => {
              const data = doc.data();
              levels.push({
                rank: data.rank || 999999,
                level: data.level || "Unnamed Level",
                player: data.player || "Unknown",
                completion: data.completion || "?",
                proof: data.proof || ''
              });
            });

            // SORT: lowest rank first (1 = top/#1, 100 = bottom)
            levels.sort((a, b) => a.rank - b.rank);

            let displayRank = 1;
            levels.forEach((entry) => {
              // Extract YouTube video ID from proof link
              let thumbUrl = 'https://via.placeholder.com/160x90/0d2432/7fb3c8?text=No+Thumbnail';
              if (entry.proof && (entry.proof.includes('youtu.be') || entry.proof.includes('youtube.com'))) {
                let videoId = '';
                if (entry.proof.includes('youtu.be/')) {
                  videoId = entry.proof.split('youtu.be/')[1]?.split('?')[0]?.split('/')[0];
                } else if (entry.proof.includes('v=')) {
                  videoId = entry.proof.split('v=')[1]?.split('&')[0];
                }
                if (videoId) {
                  thumbUrl = `https://i.ytimg.com/vi/${videoId}/maxresdefault.jpg`;
                }
              }

              const item = document.createElement("div");
              item.className = "level-item";
              item.innerHTML = `
                <img src="${thumbUrl}" alt="${entry.level} thumbnail" class="thumbnail" onerror="this.src='https://via.placeholder.com/160x90/0d2432/7fb3c8?text=No+Thumb';">
                <div class="level-info">
                  <div class="row">
                    <div class="rank">#${displayRank}</div>
                    <div>
                      <div><b>${entry.level}</b></div>
                      <div style="color:#7fb3c8; font-size:13px;">
                        by ${entry.player} ‚Ä¢ ${entry.completion}%
                      </div>
                    </div>
                  </div>
                  <div style="margin-top: 8px;">
                    <a href="${entry.proof}" target="_blank" style="color:#35e0ff; text-decoration:none;">
                      Proof ‚Üó
                    </a>
                  </div>
                </div>
              `;

              box.appendChild(item);
              displayRank++;
            });
          } catch (err) {
            console.error("Error:", err);
            box.innerHTML = `
              <div class="card" style="color:#ff6b6b; text-align:center; padding:20px;">
                Error loading levels: ${err.message}
              </div>
            `;
          }
        }

        renderLevels();
      };
      document.head.appendChild(firestoreScript);
    };
    document.head.appendChild(appScript);
  };

  loadFirebase();
</script>

</body>
</html>